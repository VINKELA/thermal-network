<div class="network-wrapper" *ngIf="network; else loading">

  <!-- Header Section -->
  <div class="header-bar">
    <div>
      <h1>{{ network.name }}</h1>
      <span class="subtitle">{{ network.network_type | titlecase }} Network • {{ nodes.length }} Nodes</span>
    </div>
    <div class="stats">
      <div class="stat-pill">
        <span class="label">Total Length</span>
        <span class="val">{{ network.total_length || 0 | number }}m</span>
      </div>
    </div>
  </div>

  <!-- Map Container -->
  <div class="map-container">
    <google-map 
      height="600px" 
      width="100%" 
      [center]="center" 
      [zoom]="zoom"
      [options]="mapOptions">
      
      <!-- Loop through Nodes -->
      <map-marker 
        *ngFor="let node of nodes"
        [position]="{ lat: node.latitude || 0, lng: node.longitude || 0 }"
        [options]="getMarkerOptions(node)"
        (mapClick)="openNodeInfo(markerRef, node)"
        #markerRef="mapMarker">
      </map-marker>

      <!-- Info Window (Popup) -->
      <map-info-window>
        <div class="info-popup" *ngIf="selectedNode">
          <h3>{{ selectedNode.name }}</h3>
          <span class="badge" [class]="selectedNode?.node_type">{{ selectedNode.node_type }}</span>
          
          <div class="details" *ngIf="selectedNode?.building">
            <p><strong>Connected:</strong> {{ selectedNode.building.name }}</p>
          </div>
          
          <button (click)="navigateToNode(selectedNode.id)">View Node Details</button>
        </div>
      </map-info-window>

    </google-map>

    <!-- FLOATING LEGEND -->
    <div class="legend-card">
      <h4>Map Legend</h4>
      <div class="legend-item">
        <span class="symbol producer">▲</span> 
        <span>Producer (Plant)</span>
      </div>
      <div class="legend-item">
        <span class="symbol consumer">●</span> 
        <span>Consumer (Building)</span>
      </div>
      <div class="legend-item">
        <span class="symbol storage">►</span> 
        <span>Storage</span>
      </div>
    </div>

  </div>

</div>

<ng-template #loading>
  <div class="skeleton-loader">Loading Network Topology...</div>
</ng-template>